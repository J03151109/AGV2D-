<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Multi-AGV 搬送シミュレーター</title>
  <style>
    body {
      display: flex;
      font-family: sans-serif;
      margin: 0;
    }
    #controls {
      width: 240px;
      padding: 10px;
      border-left: 1px solid #ccc;
      background: #f0f0f0;
    }
    #main {
      flex: 1;
      padding: 10px;
    }
    canvas {
      border: 1px solid #aaa;
      background: #fff;
      display: block;
      margin-bottom: 10px;
    }
    input, button, select {
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    h2 {
      margin-top: 0;
    }
    label {
      font-size: 14px;
      display: block;
      margin-top: 10px;
    }
    #timeDisplay {
      margin-top: 20px;
      font-weight: bold;
    }
    #usage {
      margin-top: 30px;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div id="main">
    <h2>Multi-AGV シミュレーター</h2>
    <canvas id="simCanvas" width="1500" height="1000"></canvas>
    <div id="timeDisplay">搬送時間：-- 秒</div>
    <div id="usage">
      <h3>【使い方】</h3>
      <ol>
        <li>ルートを作成する（スタート地点「S」、ゴール地点「G」も決定）</li>
        <li>各AGVのスタート地点を決める</li>
        <li>速度や停止時間などの条件を入力する</li>
        <li>シミュレーションを開始する</li>
        <li>AGV1台の往復にかかる時間を確認する</li>
      </ol>
    </div>
  </div>
  <div id="controls">
    <label>
      直線移動速度（m/min）:
      <input type="number" id="linearSpeed" value="60" min="1">
    </label>
    <label>
      旋回時間（直角ターン時、秒）:
      <input type="number" id="turnTime" value="2" min="0">
    </label>
    <label>
      円弧走行速度（m/min）:
      <input type="number" id="arcSpeed" value="40" min="1">
    </label>
    <label>
      待機時間（スタート・ゴール地点、秒）:
      <input type="number" id="waitTime" value="10" min="0">
    </label>
    <button onclick="location.reload()">ページをリロード</button>
  </div>

  <script>
    const canvas = document.getElementById("simCanvas");
    const ctx = canvas.getContext("2d");
    const timeDisplay = document.getElementById("timeDisplay");

    const cols = 30;
    const rows = 20;
    const cellSize = 50;

    const start = { x: 1, y: 1 };
    const goal = { x: 28, y: 18 };

    const agvs = [
      { id: 1, color: "blue", x: start.x, y: start.y },
      { id: 2, color: "red", x: start.x, y: start.y },
      { id: 3, color: "green", x: start.x, y: start.y },
      { id: 4, color: "orange", x: start.x, y: start.y },
      { id: 5, color: "purple", x: start.x, y: start.y }
    ];

    function drawGrid() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#ddd';

      for (let i = 0; i <= cols; i++) {
        const x = i * cellSize;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, rows * cellSize);
        ctx.stroke();
      }

      for (let j = 0; j <= rows; j++) {
        const y = j * cellSize;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(cols * cellSize, y);
        ctx.stroke();
      }
    }

    function drawStartGoal() {
      ctx.fillStyle = "green";
      ctx.font = "20px sans-serif";
      ctx.fillText("S", start.x * cellSize + 15, start.y * cellSize + 35);

      ctx.fillStyle = "red";
      ctx.font = "20px sans-serif";
      ctx.fillText("G", goal.x * cellSize + 15, goal.y * cellSize + 35);
    }

    function drawAGVs() {
      agvs.forEach(agv => {
        ctx.fillStyle = agv.color;
        ctx.beginPath();
        ctx.arc(agv.x * cellSize + cellSize / 2, agv.y * cellSize + cellSize / 2, 15, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "white";
        ctx.font = "14px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(agv.id, agv.x * cellSize + cellSize / 2, agv.y * cellSize + cellSize / 2);
      });
    }

    function calculateTime() {
      const dx = Math.abs(goal.x - start.x);
      const dy = Math.abs(goal.y - start.y);
      const linearSpeed = parseFloat(document.getElementById("linearSpeed").value);
      const turnTime = parseFloat(document.getElementById("turnTime").value);
      const waitTime = parseFloat(document.getElementById("waitTime").value);

      const distance = (dx + dy);
      const timeMove = (distance * cellSize / 1000) / (linearSpeed / 60);
      const turns = (dx > 0 && dy > 0) ? 1 : 0;
      const oneWay = timeMove + turns * turnTime;

      const totalTime = oneWay * 2 + waitTime * 2;
      return totalTime.toFixed(1);
    }

    function drawMessage() {
      ctx.fillStyle = "#888";
      ctx.font = "18px sans-serif";
      ctx.fillText("縦20マス × 横30マスのグリッド", 50, 30);
    }

    function update() {
      drawGrid();
      drawStartGoal();
      drawAGVs();
      drawMessage();
      const totalTime = calculateTime();
      timeDisplay.textContent = `搬送時間（往復・待機込）：${totalTime} 秒`;
    }

    update();
  </script>
</body>
</html>
